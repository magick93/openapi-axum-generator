use axum::{
    body::Body,
    http::StatusCode,
    response::{IntoResponse, Response},
    routing::{get, post},
    Json, Router,
};
use serde::Serialize;
use utoipa::{OpenApi, ToSchema};

// Generate models from OpenAPI schemas with ToSchema derive
{% for schema in schemas %}
#[derive(Serialize, ToSchema)]
struct {{ schema.name }} {
    {% for field in schema.fields %}
    #[schema(example = "{{ field.field_type }}")]
    {{ field.name }}: {{ field.field_type }},
    {% endfor %}
}
{% endfor %}

// Generate handlers from OpenAPI paths with utoipa path annotations
{% for route in routes %}
/// {{ route.method }} handler for {{ route.path }}
#[utoipa::path(
    {{ route.method }},
    path = "{{ route.path }}",
    responses(
        {% for response in route.responses %}
        (status = {{ response.status_code }}, description = "{{ response.description }}", body = {{ response.content_type }}),
        {% endfor %}
        (status = 404, description = "not found", body = String),
    ),
    params(
        {% for param in route.parameters %}
        ("{{ param.name }}" = {{ param.param_type }},  description = "{{ param.name }}", required = {{ param.required }}),
        {% endfor %}
    )
)]
async fn {{ route.handler_name }}() -> impl IntoResponse {
    Response::builder()
        .status(StatusCode::OK)
        .body(Body::from("{{ route.handler_name }} response"))
        .unwrap()
}
{% endfor %}

// Create router with all routes
pub fn create_router() -> Router {
    let mut router = Router::new();
    {% for route in routes %}
    router = router.route("{{ route.path }}", {{ route.method }}!({{ route.handler_name }}));
    {% endfor %}
    router
}

// Generate OpenAPI documentation
#[derive(OpenApi)]
#[openapi(
    paths(
        {% for route in routes %}
        {{ route.handler_name }},
        {% endfor %}
    ),
    components(
        schemas(
            {% for schema in schemas %}
            {{ schema.name }},
            {% endfor %}
        )
    ),
    
)]
struct ApiDoc;

pub fn openapi_spec() -> utoipa::openapi::OpenApi {
    ApiDoc::openapi()
}
